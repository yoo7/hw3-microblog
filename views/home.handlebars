{{! Use the main layout }}
{{!< main }}

{{! New Post Submission Form }}
<section class="content-container gaegu-regular">
    {{#if loggedIn}}
        <!-- show the create post form when logged in -->
        <section class="post-form">
            <!-- make a header here -->
            <form action="/posts" method="POST">
                <!-- title input field name = "title" -->
                <input class="gaegu-regular" type="text" id="title" name="title" required=true placeholder="Title"/>

                <!-- text area input field name = "content" -->
                <textarea class="gaegu-regular" id="content" name="content" required=true placeholder="What's happening?"></textarea>

                <div class="form-actions">
                    <button type="button" class="emoji-button gaegu-regular" onclick="toggleEmojiPanel()">ðŸ˜€</button>
                    <button type="submit" class="post-button gaegu-regular">POST</button>
                </div>
            </form>

            <div id="emoji-container" class="emoji-panel" style="display: none;">
                <!-- input field for the emoji search -->
                <input class="gaegu-regular" type="search" id="emoji-search" name="search" placeholder="Search for an emoji" oninput="searchEmojis()"/>

                <div id="emoji-grid">

                </div>
            </div>
        </section>
    {{/if}}

    <section class="posts-list">
        <!-- recent posts -->
        <h2 class="gaegu-regular">&mdash; Recent {{toLowerCase postNeoType}}s from {{postNeoType}}-Takers &mdash;</h2>

        {{#if posts.length}}
        <ul>
            {{#each posts}}
                <!-- you have to pass the user in to posts and this is the syntax -->
                {{> post this user=../user}}            
            {{/each}}
        </ul>
        {{else}}
            <!-- no posts, oh no, what now? -->
        {{/if}}
    </section>
</section>


{{! JavaScript for Emoji Integration }}
<script>

/*
 You want to show a subset of the emojis. About 200. However,
 you also want the user to be able to search all emojis,
 so, put them in this array when the array is empty so 
 that you have them.
*/

let allEmojis = [];  // Global list to hold all emojis

function toggleEmojiPanel() {
    const container = document.getElementById("emoji-container");
    container.style.display = container.style.display === "none" ? "block" : "none";

    if (container.style.display === "block" && allEmojis.length === 0) {
        // Go "Fetch" you some emojis and show them off with displayEmojis
        // TODO Later: use .config file or environment variables so we don't hard-code the API key?
        const apiKey = "828c77b09984470071838f84685c16e107a613a5";
        const url = `https://emoji-api.com/emojis?access_key=${apiKey}`;

        // Fetch emojis, turn the response into JSON, update allEmojis, anddisplay the toggle
        fetch(url)
            .then(response => response.json())
            .then(data => {
                allEmojis = data;
                displayEmojis(allEmojis);
            })
            .catch(error => {
                console.error("Error fetching emojis:", error);
            });
    }
}

function displayEmojis(emojis,limit=200) {
    const container = document.getElementById("emoji-grid");
    container.innerHTML = '';  // Clear previous results

    if (Array.isArray(emojis) && emojis.length > 0) {
        emojis.slice(0, limit).forEach(emoji => {
            const emojiElement = document.createElement("span");
            emojiElement.textContent = emoji.character;
            emojiElement.title = emoji.slug;  // Showing the emoji name on hover
            emojiElement.style.cursor = "pointer";
            emojiElement.onclick = () => insertEmoji(emoji.character);
            container.appendChild(emojiElement);
        });
    } else {
        container.textContent = "No emojis found. Try a different search!";
    }
}

// Get the emojis whose names contain the substring searchTerm
function searchEmojis() {
    const searchTerm = document.getElementById("emoji-search").value.toLowerCase();

    // Look through the array of JS objects -- for each object, check the "slug" attribute
    // and see if that string contains the searchTerm
    const filteredEmojis = allEmojis.filter((obj) => obj.slug.includes(searchTerm));
    
    displayEmojis(filteredEmojis);
}

// Put emoji on the form
// Reference: https://stackoverflow.com/a/2345915
function insertEmoji(emoji) {
    const textarea = document.getElementById("content");

    textarea.focus();  // Keep focus on the textarea

    // Append to the innerHTML rather than textContent because emojis are encoded in HTML
    // Append to the end of the innerHTML but before the div ends
    textarea.insertAdjacentHTML("beforeend", emoji);

    // Make the user cursor show up after the just-inserted-emoji
    const val = textarea.innerHTML;  // Store the value
    textarea.innerHTML = "";  // Reset
    textarea.innerHTML = val;  // Set the old value again
    
    console.log(textarea.value);
    console.log(textarea.textContent);
    console.log(textarea.innerHTML);

    /*
    console.log(textarea.textContent);
    // Append to the innerHTML rather than textContent because emojis are encoded in HTML
    // Append to the end of the innerHTML but before the div ends
    textarea.insertAdjacentHTML("beforeend", emoji);

    console.log(textarea.textContent);
    textarea.focus();
    // Make the user cursor show up after the just-inserted-emoji
    const val = textarea.innerHTML;  // Store the value
    textarea.innerHTML = "";  // Reset
    textarea.innerHTML = val;  // Set the old value again
    */
}

</script>

